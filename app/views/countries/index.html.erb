<% content_for :title, "Countries" %>

<h1>Countries</h1>

<div data-controller="map" data-map-data-value='<%= @countries_data.to_json %>' style="width: 960px; height: 650px; margin-bottom: 2rem;"></div>

<% if @shared_mode %>
  <div style="background-color: #e3f2fd; border: 1px solid #90caf9; border-radius: 4px; padding: 1rem; margin-bottom: 1.5rem;">
    <h2 style="margin-top: 0;">ğŸŒ Shared Travel Map</h2>
    <p style="color: #666; margin-bottom: 0.5rem;">You're viewing someone's travel heatmap!</p>
    <p style="color: #666; margin-bottom: 0;">
      <a href="<%= countries_path %>" style="color: #0066cc; text-decoration: none;">Create your own map â†’</a>
    </p>
  </div>
<% else %>
  <div style="margin-bottom: 1.5rem;">
    <p style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">
      ğŸ’¡ Tip: Your changes are automatically saved.
      <span id="save-status" style="margin-left: 0.5rem; font-weight: 500;"></span>
    </p>
    <button type="button" id="share-button" style="padding: 0.75rem 1.5rem; background-color: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; margin-bottom: 1rem;">
      ğŸ“¤ Share Your Map
    </button>
    <button type="button" id="update-shared-button" style="display: none; padding: 0.75rem 1.5rem; background-color: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; margin-bottom: 1rem; margin-left: 0.5rem;">
      ğŸ”„ Update Shared Link
    </button>
    </button>
    <div id="share-link-container" style="display: none; background-color: #f5f5f5; border: 1px solid #ddd; border-radius: 4px; padding: 1rem; margin-top: 0.5rem;">
      <p style="margin-top: 0; color: #666; font-size: 0.9rem;">Share this link with your friends:</p>
      <div style="display: flex; gap: 0.5rem; align-items: center;">
        <input type="text" id="share-link-input" readonly style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 0.9rem;" />
        <button type="button" id="copy-link-button" style="padding: 0.5rem 1rem; background-color: #0066cc; color: white; border: none; border-radius: 4px; cursor: pointer; white-space: nowrap;">
          ğŸ“‹ Copy
        </button>
      </div>
      <p id="copy-success" style="display: none; color: #4caf50; margin-bottom: 0; margin-top: 0.5rem; font-size: 0.9rem;">âœ“ Link copied to clipboard!</p>
    </div>
  </div>

  <h2>Select Visited Countries</h2>
  <p style="color: #666; margin-bottom: 1rem;">Check the countries you've visited, and optionally enter how many times. Default is 1.</p>

  <div style="margin-bottom: 1rem;">
    <input type="text" id="country-search" placeholder="Search countries..." style="width: 100%; max-width: 400px; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;" />
  </div>
<% end %>

<% if @shared_mode %>
  <h2>Visited Countries</h2>
  <div style="margin-bottom: 1rem;">
    <% visited_countries = @countries_data.select { |c| c[:visited] }.sort_by { |c| c[:name] } %>
    <% home = visited_countries.find { |c| c[:home_country] } %>
    <% if visited_countries.any? %>
      <p style="color: #666; margin-bottom: 0.5rem;">This traveler has visited <%= visited_countries.count %> <%= visited_countries.count == 1 ? 'country' : 'countries' %><% if home %> and calls <%= home[:name] %> home ğŸ <% end %>:</p>
      <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 1rem;">
        <% visited_countries.each do |country| %>
          <div style="background-color: <%= country[:home_country] ? '#e8f5e9' : '#f5f5f5' %>; border: 1px solid <%= country[:home_country] ? '#4caf50' : '#ddd' %>; border-radius: 4px; padding: 0.5rem 1rem; display: flex; align-items: center; gap: 0.5rem;">
            <% if country[:home_country] %>
              <span style="font-size: 1rem;">ğŸ </span>
            <% end %>
            <span style="font-weight: 500;"><%= country[:name] %></span>
            <span style="background-color: #0066cc; color: white; border-radius: 12px; padding: 0.125rem 0.5rem; font-size: 0.85rem; font-weight: bold;">
              <%= country[:visit_count] %>
            </span>
          </div>
        <% end %>
      </div>
    <% else %>
      <p style="color: #999;">No countries visited yet.</p>
    <% end %>
  </div>
<% else %>
  <%= form_tag update_visited_countries_path, method: :patch, data: { turbo: false }, id: 'countries-form' do %>
    <div id="country-list" style="margin-bottom: 1rem;">
      <% @countries_data.each do |country| %>
        <div class="country-item" data-country-name="<%= country[:name].downcase %>" style="padding: 0.25rem; display: flex; align-items: center; gap: 0.5rem;">
              <%= check_box_tag "countries[#{country[:id]}][visited]", "1", country[:visited], id: "country_#{country[:id]}", class: "country-checkbox", "data-country-id" => country[:id] %>
          <%= label_tag "country_#{country[:id]}", country[:name], style: "margin-left: 0.5rem; cursor: pointer; flex: 1; max-width: 200px;" %>
          <% if country[:home_country] %>
            <span style="background-color: #4caf50; color: white; border-radius: 4px; padding: 0.125rem 0.5rem; font-size: 0.85rem; font-weight: bold;">ğŸ  HOME</span>
          <% end %>
          <span style="margin-left: auto; display: flex; align-items: center; gap: 0.5rem;">
            <label for="country_count_<%= country[:id] %>" style="font-size: 0.9rem; color: #666;">Visits:</label>
            <%= number_field_tag "countries[#{country[:id]}][visit_count]", country[:visit_count], min: 1, max: 99, id: "country_count_#{country[:id]}", style: "width: 60px; padding: 0.25rem; border: 1px solid #ddd; border-radius: 4px;", disabled: !country[:visited], class: "visit-count-input" %>
            <%= check_box_tag "countries[#{country[:id]}][home_country]", "1", country[:home_country], id: "country_home_#{country[:id]}", title: "Mark as home country", style: "margin-left: 0.5rem; cursor: pointer;", disabled: !country[:visited], class: "home-country-checkbox", "data-country-id" => country[:id] %>
            <label for="country_home_<%= country[:id] %>" style="font-size: 0.9rem; color: #666; cursor: pointer;" title="Mark as home country">ğŸ </label>
          </span>
        </div>
      <% end %>
    </div>
  <% end %>
<% end %>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    <% unless @shared_mode %>
    const searchInput = document.getElementById('country-search');
    const countryItems = document.querySelectorAll('.country-item');
    
    // Search functionality
    searchInput.addEventListener('input', function() {
      const searchTerm = this.value.toLowerCase().trim();
      
      countryItems.forEach(function(item) {
        const countryName = item.getAttribute('data-country-name');
        if (countryName.includes(searchTerm)) {
          item.style.display = '';
        } else {
          item.style.display = 'none';
        }
      });
    });
    
    // Auto-save functionality
    let saveTimeout = null;
    let isSaving = false;
    const saveStatus = document.getElementById('save-status');
    
    function autoSave() {
      if (isSaving) return;
      
      clearTimeout(saveTimeout);
      saveTimeout = setTimeout(async () => {
        isSaving = true;
        const form = document.getElementById('countries-form');
        const formData = new FormData(form);
        
        // Show saving indicator
        saveStatus.textContent = 'ğŸ’¾ Saving...';
        saveStatus.style.color = '#666';
        
        try {
          const response = await fetch(form.action, {
            method: 'PATCH',
            headers: {
              'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
              'Accept': 'application/json'
            },
            body: formData
          });
          
          if (response.ok) {
            saveStatus.textContent = 'âœ“ Saved';
            saveStatus.style.color = '#4caf50';
            setTimeout(() => {
              saveStatus.textContent = '';
            }, 2000);
          } else {
            throw new Error('Save failed');
          }
        } catch (error) {
          console.error('Auto-save error:', error);
          saveStatus.textContent = 'âŒ Save failed';
          saveStatus.style.color = '#f44336';
          setTimeout(() => {
            saveStatus.textContent = '';
          }, 3000);
        } finally {
          isSaving = false;
        }
      }, 1000); // Wait 1 second after last change before saving
    }
    
    // Enable/disable visit count inputs based on checkbox state
    const checkboxes = document.querySelectorAll('.country-checkbox');
    checkboxes.forEach(function(checkbox) {
      const countryId = checkbox.getAttribute('data-country-id');
      const countInput = document.getElementById(`country_count_${countryId}`);
      const homeCheckbox = document.getElementById(`country_home_${countryId}`);
      
      // Set initial state based on whether checkbox is checked
      countInput.disabled = !checkbox.checked;
      if (homeCheckbox) {
        homeCheckbox.disabled = !checkbox.checked;
      }
      
      checkbox.addEventListener('change', function() {
        countInput.disabled = !this.checked;
        if (homeCheckbox) {
          homeCheckbox.disabled = !this.checked;
          if (!this.checked) {
            homeCheckbox.checked = false;
          }
        }
        if (this.checked) {
          if (countInput.value === '' || countInput.value === '0') {
            countInput.value = '1';
          }
          // Dispatch event to update map
          const event = new CustomEvent('country-changed', {
            detail: { countryId: countryId, visitCount: parseInt(countInput.value) || 1, homeCountry: homeCheckbox ? homeCheckbox.checked : false }
          });
          document.dispatchEvent(event);
        } else {
          countInput.value = '1'; // Reset to 1 when unchecked
          // Dispatch event to update map (0 = unchecked)
          const event = new CustomEvent('country-changed', {
            detail: { countryId: countryId, visitCount: 0, homeCountry: false }
          });
          document.dispatchEvent(event);
        }
        // Trigger auto-save
        autoSave();
      });
      
      // Also update map when visit count changes
      countInput.addEventListener('change', function() {
        if (checkbox.checked) {
          const event = new CustomEvent('country-changed', {
            detail: { countryId: countryId, visitCount: parseInt(this.value) || 1, homeCountry: homeCheckbox ? homeCheckbox.checked : false }
          });
          document.dispatchEvent(event);
        }
        // Trigger auto-save
        autoSave();
      });
    });
    
    // Handle home country checkboxes - only one can be checked at a time
    const homeCheckboxes = document.querySelectorAll('.home-country-checkbox');
    homeCheckboxes.forEach(function(homeCheckbox) {
      homeCheckbox.addEventListener('change', function() {
        if (this.checked) {
          // Uncheck all other home country checkboxes
          homeCheckboxes.forEach(function(otherCheckbox) {
            if (otherCheckbox !== homeCheckbox) {
              otherCheckbox.checked = false;
            }
          });
        }
        
        // Trigger map update and auto-save
        const countryId = this.getAttribute('data-country-id');
        const countInput = document.getElementById(`country_count_${countryId}`);
        const event = new CustomEvent('country-changed', {
          detail: { countryId: countryId, visitCount: parseInt(countInput.value) || 1, homeCountry: this.checked }
        });
        document.dispatchEvent(event);
        autoSave();
      });
    });
    
    // Share button functionality
    const shareButton = document.getElementById('share-button');
    const updateSharedButton = document.getElementById('update-shared-button');
    const shareLinkContainer = document.getElementById('share-link-container');
    const shareLinkInput = document.getElementById('share-link-input');
    const copyLinkButton = document.getElementById('copy-link-button');
    const copySuccess = document.getElementById('copy-success');
    
    // Check if user has an existing shared map token
    let sharedMapToken = localStorage.getItem('sharedMapToken');
    if (sharedMapToken) {
      updateSharedButton.style.display = 'inline-block';
    }
    
    async function createOrUpdateSharedMap(token = null) {
      const button = token ? updateSharedButton : shareButton;
      const originalText = button.textContent;
      button.disabled = true;
      button.textContent = 'â³ ' + (token ? 'Updating...' : 'Generating link...');
      
      try {
        // First, save the countries to the database
        const form = document.getElementById('countries-form');
        const formData = new FormData(form);
        
        button.textContent = 'â³ Saving changes...';
        const saveResponse = await fetch(form.action, {
          method: 'PATCH',
          headers: {
            'X-CSRF-Token': document.querySelector('meta[name=\"csrf-token\"]').content,
            'Accept': 'application/json'
          },
          body: formData
        });
        
        if (!saveResponse.ok) {
          throw new Error('Failed to save countries');
        }
        
        // Now update the shared map
        button.textContent = 'â³ ' + (token ? 'Updating link...' : 'Generating link...');
        const body = token ? JSON.stringify({ token: token }) : '{}';
        const response = await fetch('/countries/create_shared', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': document.querySelector('meta[name=\"csrf-token\"]').content
          },
          body: body
        });
        
        if (!response.ok) {
          throw new Error('Failed to create shared link');
        }
        
        const data = await response.json();
        
        // Store token in localStorage
        localStorage.setItem('sharedMapToken', data.token);
        sharedMapToken = data.token;
        
        // Show update button if it was hidden
        updateSharedButton.style.display = 'inline-block';
        
        // Display the shareable URL
        shareLinkInput.value = data.url;
        shareLinkContainer.style.display = 'block';
        copySuccess.style.display = 'none';
        
        // Show success message
        if (token) {
          const updateSuccess = document.createElement('p');
          updateSuccess.style.color = '#4caf50';
          updateSuccess.style.marginTop = '0.5rem';
          updateSuccess.style.fontSize = '0.9rem';
          updateSuccess.textContent = 'âœ“ Shared map updated! Anyone with your link will see the latest changes.';
          shareLinkContainer.appendChild(updateSuccess);
          setTimeout(() => updateSuccess.remove(), 5000);
        }
      } catch (error) {
        alert('Error ' + (token ? 'updating' : 'creating') + ' shareable link. Please try again.');
        console.error(error);
      } finally {
        button.disabled = false;
        button.textContent = originalText;
      }
    }
    
    shareButton.addEventListener('click', () => createOrUpdateSharedMap());
    updateSharedButton.addEventListener('click', () => createOrUpdateSharedMap(sharedMapToken));
    
    // Copy to clipboard functionality
    copyLinkButton.addEventListener('click', function() {
      shareLinkInput.select();
      navigator.clipboard.writeText(shareLinkInput.value).then(function() {
        copySuccess.style.display = 'block';
        setTimeout(function() {
          copySuccess.style.display = 'none';
        }, 3000);
      });
    });
    <% end %>
  });
</script>
