<p style="color: green"><%= notice %></p>

<% content_for :title, "Countries" %>

<h1>Countries</h1>

<div data-controller="map" data-map-data-value='<%= @countries_data.to_json %>' style="width: 960px; height: 500px; margin-bottom: 2rem;"></div>

<h2>Select Visited Countries</h2>
<p style="color: #666; margin-bottom: 1rem;">Check the countries you've visited, and optionally enter how many times. Default is 1.</p>

<div style="margin-bottom: 1rem;">
  <input type="text" id="country-search" placeholder="Search countries..." style="width: 100%; max-width: 400px; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;" />
</div>

<%= form_tag update_visited_countries_path, method: :patch, data: { turbo: false } do %>
  <div id="country-list" style="margin-bottom: 1rem;">
    <% @countries.each do |country| %>
      <div class="country-item" data-country-name="<%= country.name.downcase %>" style="padding: 0.25rem; display: flex; align-items: center; gap: 0.5rem;">
        <%= check_box_tag "countries[#{country.id}][visited]", "1", country.visited, id: "country_#{country.id}", class: "country-checkbox", data: { country_id: country.id } %>
        <%= label_tag "country_#{country.id}", country.name, style: "margin-left: 0.5rem; cursor: pointer; flex: 1; max-width: 250px;" %>
        <span style="margin-left: auto; display: flex; align-items: center; gap: 0.5rem;">
          <label for="country_count_<%= country.id %>" style="font-size: 0.9rem; color: #666;">Visits:</label>
          <%= number_field_tag "countries[#{country.id}][visit_count]", country.visit_count, min: 1, max: 99, id: "country_count_#{country.id}", style: "width: 60px; padding: 0.25rem; border: 1px solid #ddd; border-radius: 4px;", disabled: !country.visited, class: "visit-count-input" %>
        </span>
      </div>
    <% end %>
  </div>
  <%= submit_tag "Update Visited Countries", style: "padding: 0.75rem 1.5rem; background-color: #0066cc; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem;" %>
<% end %>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('country-search');
    const countryItems = document.querySelectorAll('.country-item');
    
    // Search functionality
    searchInput.addEventListener('input', function() {
      const searchTerm = this.value.toLowerCase().trim();
      
      countryItems.forEach(function(item) {
        const countryName = item.getAttribute('data-country-name');
        if (countryName.includes(searchTerm)) {
          item.style.display = '';
        } else {
          item.style.display = 'none';
        }
      });
    });
    
    // Enable/disable visit count inputs based on checkbox state
    const checkboxes = document.querySelectorAll('.country-checkbox');
    checkboxes.forEach(function(checkbox) {
      const countryId = checkbox.getAttribute('data-country-id');
      const countInput = document.getElementById(`country_count_${countryId}`);
      
      checkbox.addEventListener('change', function() {
        countInput.disabled = !this.checked;
        if (this.checked && countInput.value == '1') {
          // Keep default value of 1 when checked
        } else if (!this.checked) {
          countInput.value = '1'; // Reset to 1 when unchecked
        }
      });
    });
  });
</script>
