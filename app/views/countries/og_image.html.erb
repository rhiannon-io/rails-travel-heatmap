<%
  # Calculate stats
  visited_countries = countries_data.select { |c| c[:visited] }
  total_visits = visited_countries.sum { |c| c[:visit_count] }
  home_country = visited_countries.find { |c| c[:home_country] }
  
  # Build a lookup for coloring
  visited_iso_codes = {}
  visited_countries.each do |c|
    visited_iso_codes[c[:iso_code]] = { visits: c[:visit_count], home: c[:home_country] }
  end
  
  # Load and parse GeoJSON
  geojson_path = Rails.root.join("public", "ne_countries_admin_0.geojson")
  geojson = JSON.parse(File.read(geojson_path))
  
  # Simple projection math (Natural Earth-like for 1120x400 viewport)
  map_width = 1120
  map_height = 400
%>

<div class="container">
  <div class="header">
    <h1 class="title">
      <% if shared_map.owner_name.present? %>
        <span class="name"><%= shared_map.owner_name %>'s</span> Travel Map
      <% else %>
        Travel Heatmap
      <% end %>
    </h1>
    <div class="stats">
      <div class="stat">
        <span class="stat-value"><%= visited_countries.count %></span>
        <span>countries</span>
      </div>
      <div class="stat">
        <span class="stat-value"><%= total_visits %></span>
        <span>trips</span>
      </div>
      <% if home_country %>
        <div class="stat">
          ğŸ  <span><%= home_country[:name] %></span>
        </div>
      <% end %>
    </div>
  </div>
  
  <div class="map-container">
    <svg viewBox="0 0 <%= map_width %> <%= map_height %>" xmlns="http://www.w3.org/2000/svg">
      <rect width="100%" height="100%" fill="#1a1a2e"/>
      <% geojson["features"].each do |feature| %>
        <%
          props = feature["properties"] || {}
          iso3 = props["ISO3166-1-Alpha-3"] || props["ISO_A3"]
          iso2 = props["ISO3166-1-Alpha-2"] || props["ISO_A2"]
          
          # Check if visited
          visit_info = visited_iso_codes[iso3] || visited_iso_codes[iso2]
          
          if visit_info
            visits = visit_info[:visits]
            is_home = visit_info[:home]
            if is_home
              fill_color = "#4caf50"
            else
              fill_color = case visits
                when 1 then "#FFEB3B"
                when 2 then "#FFC107"
                when 3 then "#FF9800"
                when 4 then "#FF5722"
                when 5 then "#F44336"
                when 6..9 then "#E91E63"
                when 10..19 then "#9C27B0"
                else "#4A148C"
              end
            end
          else
            fill_color = "#2d3748"
          end
          
          geometry = feature["geometry"]
          paths = []
          
          # Process geometry to paths
          if geometry
            coords_arrays = case geometry["type"]
              when "Polygon" then [geometry["coordinates"]]
              when "MultiPolygon" then geometry["coordinates"]
              else []
            end
            
            coords_arrays.each do |polygon|
              next unless polygon.is_a?(Array) && polygon.any?
              ring = polygon[0] # outer ring
              next unless ring.is_a?(Array) && ring.any?
              
              path_parts = []
              ring.each_with_index do |point, idx|
                next unless point.is_a?(Array) && point[0].is_a?(Numeric)
                lon, lat = point[0], point[1]
                x = (lon + 180) * (map_width / 360.0)
                y = (90 - lat) * (map_height / 180.0)
                cmd = idx == 0 ? "M" : "L"
                path_parts << "#{cmd}#{x.round(1)},#{y.round(1)}"
              end
              paths << path_parts.join(" ") + "Z" if path_parts.any?
            end
          end
        %>
        <% paths.each do |path_d| %>
          <path d="<%= path_d %>" fill="<%= fill_color %>" stroke="#1a1a2e" stroke-width="0.5"/>
        <% end %>
      <% end %>
    </svg>
  </div>
  
  <div class="footer">
    <div class="brand">
      ğŸ—ºï¸ Travel Heatmap
    </div>
    <div class="cta">
      Create your own map â†’
    </div>
  </div>
</div>
